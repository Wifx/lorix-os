From d0e14bb8bc81a074024d27f103b6086131290cc9 Mon Sep 17 00:00:00 2001
From: Yannick Lanz <yannick.lanz@wifx.net>
Date: Fri, 29 Oct 2021 15:25:13 +0200
Subject: [PATCH 1/2] atmel_usba_udc: fix usb device/host initial state

Signed-off-by: Yannick Lanz <yannick.lanz@wifx.net>
---
 drivers/usb/gadget/udc/atmel_usba_udc.c | 13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

diff --git a/drivers/usb/gadget/udc/atmel_usba_udc.c b/drivers/usb/gadget/udc/atmel_usba_udc.c
index 179e9ffe343d..e5f4dea12d5b 100644
--- a/drivers/usb/gadget/udc/atmel_usba_udc.c
+++ b/drivers/usb/gadget/udc/atmel_usba_udc.c
@@ -2325,8 +2325,17 @@ static int usba_udc_probe(struct platform_device *pdev)
 
 	udc->usba_ep = atmel_udc_of_init(pdev, udc);
 
-	dev_dbg(&pdev->dev, "Disable bias\n");
-	toggle_bias(udc, 0);
+	if (id_is_device(udc)) {
+		/* This will also enable the DP pullup */
+		dev_dbg(&udc->pdev->dev, "Enable bias\n");
+		toggle_bias(udc, 1);
+		dev_dbg(&udc->pdev->dev, "Switch to device\n");
+		usba_writel(udc, CTRL, USBA_ENABLE_MASK);
+	} else {
+		/* This will also disable the DP pullup */
+		dev_dbg(&udc->pdev->dev, "Disable bias\n");
+		toggle_bias(udc, 0);
+	}
 
 	if (IS_ERR(udc->usba_ep))
 		return PTR_ERR(udc->usba_ep);
-- 
2.25.1


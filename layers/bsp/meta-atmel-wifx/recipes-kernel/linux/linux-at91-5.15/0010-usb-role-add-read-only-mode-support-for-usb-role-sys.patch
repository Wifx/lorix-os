From e9c2b31c46f51d3c9f6a675197342451bd005f25 Mon Sep 17 00:00:00 2001
From: Yannick Lanz <yannick.lanz@wifx.net>
Date: Wed, 19 Oct 2022 15:01:32 +0200
Subject: [PATCH 1/2] usb-role: add read-only mode support for usb-role sysfs
 access

Signed-off-by: Yannick Lanz <yannick.lanz@wifx.net>
---
 drivers/usb/roles/class.c | 13 ++++++++++---
 include/linux/usb/role.h  |  3 ++-
 2 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/drivers/usb/roles/class.c b/drivers/usb/roles/class.c
index dfaed7eee94f..0f39ed33e377 100644
--- a/drivers/usb/roles/class.c
+++ b/drivers/usb/roles/class.c
@@ -27,7 +27,8 @@ struct usb_role_switch {
 	struct device *udc;
 	usb_role_switch_set_t set;
 	usb_role_switch_get_t get;
-	bool allow_userspace_control;
+	bool userspace_enable;
+	bool userspace_allow_write;
 };
 
 #define to_role_switch(d)	container_of(d, struct usb_role_switch, dev)
@@ -202,7 +203,7 @@ usb_role_switch_is_visible(struct kobject *kobj, struct attribute *attr, int n)
 	struct device *dev = kobj_to_dev(kobj);
 	struct usb_role_switch *sw = to_role_switch(dev);
 
-	if (sw->allow_userspace_control)
+	if (sw->userspace_enable)
 		return attr->mode;
 
 	return 0;
@@ -327,13 +328,19 @@ usb_role_switch_register(struct device *parent,
 
 	mutex_init(&sw->lock);
 
-	sw->allow_userspace_control = desc->allow_userspace_control;
+	sw->userspace_enable = desc->userspace_enable;
+	sw->userspace_allow_write = desc->userspace_allow_write;
 	sw->usb2_port = desc->usb2_port;
 	sw->usb3_port = desc->usb3_port;
 	sw->udc = desc->udc;
 	sw->set = desc->set;
 	sw->get = desc->get;
 
+	if (!sw->userspace_allow_write) {
+		dev_attr_role.attr.mode &= ~0x200;
+		dev_attr_role.store = NULL;
+	}
+
 	sw->dev.parent = parent;
 	sw->dev.fwnode = desc->fwnode;
 	sw->dev.class = role_class;
diff --git a/include/linux/usb/role.h b/include/linux/usb/role.h
index b5deafd91f67..e9a749a2b267 100644
--- a/include/linux/usb/role.h
+++ b/include/linux/usb/role.h
@@ -42,7 +42,8 @@ struct usb_role_switch_desc {
 	struct device *udc;
 	usb_role_switch_set_t set;
 	usb_role_switch_get_t get;
-	bool allow_userspace_control;
+	bool userspace_enable;
+	bool userspace_allow_write;
 	void *driver_data;
 	const char *name;
 };
-- 
2.34.1

